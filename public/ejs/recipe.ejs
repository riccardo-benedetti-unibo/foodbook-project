<!-- views/mainpage.ejs -->
<!doctype html>
<html>
<head>
	<title><%= recipe.title %></title>
	<link href="../css/foodbook.css" rel="stylesheet" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
	
<body onload="javascript:init()">
<div class="container">
	<div class="menuContainer">
		<ul>
			<li>
				<a href="/mainpage">RecipeDashboard</a>
			</li>
            <% if(user){ %>
			<li>
				<a href="/cookbook">MyCookbook</a>
			</li>
            <% } %>
			<li>
				<a href="/analytics">Analytics</a>
			</li>
			<li>
                <% if(user){ %>
				<a href="/logout">Logout</a>
                <% } else { %>
				<a href="/">SignIn</a>
                <% } %>

			</li>
            <% if(user){ %>
			<text style="float:right;">
				<text>Logged as:</text>
				<text><b><%= user %></b></text>
			</text>
            <% } %>
		</ul>
	</div>

	<div class="rcontainer">
		<ul>
			<li>
				<div class="rheader">
					<div class="rheaderinfo">
						<h1><i><%= recipe.title %></i></h1>
						<p id="plike">Added to: <b><%= recipe.likes %> Cookbooks</b></p>
						<p id="prating">Average rating: <b><%= Math.round(avgRating * 100) / 100 %> Stars</b></p>
					</div>
					<div class="rheaderlike">
                        <% if(user){ %>
						<form method="post" id="likeform">
							<div class="fdbButton" id="divLike" style="background-color: gold">
								<input type="hidden" name="recipeid" value="<%= recipe._id %>" />
								<a href="#" id="btnLike" onclick="javascript:toggle();"> Null Text </a>
							</div>
						</form>
                        <% } %>
					</div>
				</div>
			</li>
			<li>
				<div class="rbody">
					<div class="rimage">
						<figure>
							<img src='<%= recipe.image %>' alt="">
						</figure><br>
					</div>
					<div class="rdetails">
						<div class="rdmenu">
							<ul>
								<li id="ingredients"><a href="#" onclick="javascript:displayIngredients();">Ingredients</a></li>
								<li id="instructions"><a href="#" onclick="javascript:displayInstructions();">Instructions</a></li>
							</ul>
						</div>
						<div class="rdcontent">
							<p><ul id="rdinfo"></ul></p>
						</div>
					</div>
				</div>
			</li>
            <% if(user){ %>
			<li>
				<div class="rdstars">
					<strong>Rate this recipe: </strong>
					<form action="/raterecipe" method="post" id="ratingform">
						<input type="hidden" name="recipeid" value="<%= recipe._id %>" />
						<input class="star star-5" id="star-5" type="radio" name="star" value="5" onclick="this.form.submit();"/>
						<label class="star star-5" for="star-5"></label>
						<input class="star star-4" id="star-4" type="radio" name="star" value="4" onclick="this.form.submit();"/>
						<label class="star star-4" for="star-4"></label>
						<input class="star star-3" id="star-3" type="radio" name="star" value="3" onclick="this.form.submit();"/>
						<label class="star star-3" for="star-3"></label>
						<input class="star star-2" id="star-2" type="radio" name="star" value="2" onclick="this.form.submit();"/>
						<label class="star star-2" for="star-2"></label>
						<input class="star star-1" id="star-1" type="radio" name="star" value="1" onclick="this.form.submit();"/>
						<label class="star star-1" for="star-1"></label>
					</form>
				</div>
			</li>
            <% } %>
		</ul>
	</div>
</div>
</body>

<script type="text/javascript">
	function toggle() {
		var textElem = document.getElementById("btnLike");
		var btnElem = document.getElementById("divLike");
		if (textElem.text=="REMOVE FROM MY COOKBOOK"){
            textElem.text = "ADD TO MY COOKBOOK";
            btnElem.style.backgroundColor = "#e6e6d0";
		} else {
            textElem.text = "REMOVE FROM MY COOKBOOK";
            btnElem.style.backgroundColor = "#bdbdae";
		}
    }
</script>

<script type="text/javascript">
	function init() {
	    if('<%= user %>' != '') {
            window.state = '<%= likestate %>';
            window.likes = '<%= recipe.likes %>';
            var textElem = document.getElementById("btnLike");
            var btnElem = document.getElementById("divLike");
            if(window.state == 'true'){
                textElem.text = "REMOVE FROM MY COOKBOOK";
                btnElem.style.backgroundColor = "#bdbdae";
            }else{
                textElem.text = "ADD TO MY COOKBOOK";
                btnElem.style.backgroundColor = "#e6e6d0";
            }
            if('<%= userRate %>'){
                var $rstars = $('input:radio[name=star]');
                if($rstars.is(':checked')===false){
                    $rstars.filter('[value=<%= userRate %>]').prop('checked', true);
                }
            }
		}
		displayIngredients();
	}
</script>

<script>
	$('#likeform').click(function(event) {
		event.preventDefault();
		$.ajax({
			type        : 'POST', // define the type of HTTP verb we want to use (POST for our form)
			url         : '/likerecipe', // the url where we want to POST
			data		: { 'recipeid' : $('input[name=recipeid]').val() },
			encode      : true
		}).done(function(){
            if(window.state == 'true'){
                window.state = 'false';
                window.likes = parseInt(window.likes)-1;
            }else{
                window.state = 'true';
                window.likes = parseInt(window.likes)+1;
            }
            document.getElementById("plike").innerHTML = "Added to: <b>"+ window.likes + " Cookbooks</b><br>";
		});
	});
</script>

<script type="text/javascript">
	function displayInstructions() {
		var p = document.getElementById('rdinfo');
		p.innerHTML = "";
		p.innerHTML = '<b>Preparation time: ' + '<%= recipe.readyInMinutes %>' + ' mins</b><br>';
		p.innerHTML += '<%= recipe.instructions %>';
    }
</script>

<script type="text/javascript">
	function displayIngredients() {
		var p = document.getElementById('rdinfo');
        p.innerHTML = "";
		<% recipe.ingredients.forEach(function(ing,i) {%>
			p.innerHTML += "<li>" + '<%= ing.name %>' + ": " + '<%= Math.round(ing.amount * 100) / 100 %>' + " " + '<%= ing.unitLong %>' + "</li>";
		<% }); %>
	}
</script>
</html>